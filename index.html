<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Medical Report Analytics</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Library for parsing Excel files (will be used by the worker) -->
    <script src="https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .kpi-card {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
            transition: all 0.3s ease;
        }
        .kpi-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }
        .chart-container, .analysis-container {
            background-color: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }
        #upload-container {
            border-style: dashed;
        }
    </style>
</head>
<body class="antialiased text-gray-800">

    <div class="min-h-screen p-4 sm:p-6 lg:p-8">
        <div class="max-w-7xl mx-auto">
            
            <!-- Header -->
            <header class="mb-8">
                <h1 class="text-3xl font-bold text-gray-900">Medical Report Analytics</h1>
                <p class="text-gray-600 mt-1">Upload your patient visit report to generate an interactive dashboard.</p>
            </header>

            <!-- File Upload -->
            <div id="upload-container" class="mb-8 p-8 text-center bg-white border-2 border-gray-300 rounded-lg">
                <h2 class="text-xl font-semibold mb-2">Upload Report File</h2>
                <p class="text-gray-500 mb-4">Select an Excel (.xlsx, .xls, .csv) or Text (.txt) file.</p>
                <input type="file" id="fileInput" accept=".xlsx,.xls,.csv,.txt" class="mx-auto block text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"/>
                <p id="fileName" class="mt-4 text-gray-600"></p>
                <div id="loading" class="hidden mt-4">
                    <svg class="animate-spin h-5 w-5 text-blue-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                        <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                        <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                    <span id="loadingText" class="text-sm text-gray-500">Processing...</span>
                </div>
            </div>

            <!-- Dashboard Content (hidden by default) -->
            <div id="dashboard" class="hidden space-y-8">
                <!-- KPIs -->
                 <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-6 gap-6">
                    <div class="kpi-card">
                        <h3 class="text-sm font-medium text-gray-500">Total Patients</h3>
                        <p id="totalPatients" class="text-3xl font-semibold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-sm font-medium text-gray-500">Total Visits</h3>
                        <p id="totalVisits" class="text-3xl font-semibold text-gray-900 mt-1">0</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-sm font-medium text-gray-500">Total Charges</h3>
                        <p id="totalCharges" class="text-3xl font-semibold text-gray-900 mt-1">$0.00</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-sm font-medium text-gray-500">Total Payments</h3>
                        <p id="totalPayments" class="text-3xl font-semibold text-green-600 mt-1">$0.00</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-sm font-medium text-gray-500">Total Adjustments</h3>
                        <p id="totalAdjustments" class="text-3xl font-semibold text-yellow-600 mt-1">$0.00</p>
                    </div>
                    <div class="kpi-card">
                        <h3 class="text-sm font-medium text-gray-500">Outstanding Balance</h3>
                        <p id="totalBalance" class="text-3xl font-semibold text-red-600 mt-1">$0.00</p>
                    </div>
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-5 gap-8">
                    <div class="chart-container lg:col-span-3">
                        <h3 class="text-lg font-semibold mb-4">Financial Overview</h3>
                        <canvas id="financialChart"></canvas>
                    </div>
                    <div class="chart-container lg:col-span-2">
                        <h3 class="text-lg font-semibold mb-4">Top 5 CPT Codes by Charges</h3>
                        <canvas id="cptChart"></canvas>
                    </div>
                </div>
                <div class="chart-container">
                    <h3 class="text-lg font-semibold mb-4">Monthly Trends (Charges vs Payments)</h3>
                    <canvas id="monthlyTrendChart"></canvas>
                </div>

                <!-- CPT Analysis Table -->
                <div class="analysis-container">
                    <h3 class="text-lg font-semibold mb-4">CPT Analysis for Sun Health Care Surgery Group Inc (Codes: L, Q, A)</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPT Code</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Units Billed</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Units Paid</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Total Payment</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Avg. Pay Per Unit</th>
                                </tr>
                            </thead>
                            <tbody id="cptAnalysisTable" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Payer Payment Analysis Table -->
                <div class="analysis-container">
                    <h3 class="text-lg font-semibold mb-4">Payer Payment Breakdown by CPT Code</h3>
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPT Code</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payer</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Payment Amount</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Frequency</th>
                                </tr>
                            </thead>
                            <tbody id="payerPaymentTable" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Main Data Table -->
                <div class="analysis-container">
                    <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                        <h3 class="text-lg font-semibold">Detailed Visit Data</h3>
                        <button id="exportCsv" class="px-4 py-2 bg-blue-600 text-white text-sm font-medium rounded-md hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                            Export to CSV
                        </button>
                    </div>
                     <input type="text" id="searchInput" placeholder="Search table..." class="w-full sm:w-1/3 p-2 border border-gray-300 rounded-md mb-4 focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                    <div class="overflow-x-auto">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Patient Name</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Office</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Payer</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Service Date</th>
                                    <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">CPT</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Charges</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Payments</th>
                                    <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider">Balance</th>
                                </tr>
                            </thead>
                            <tbody id="dataTable" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- UI ELEMENTS ---
        const fileInput = document.getElementById('fileInput');
        const fileNameDisplay = document.getElementById('fileName');
        const loadingSpinner = document.getElementById('loading');
        const loadingText = document.getElementById('loadingText');
        const dashboard = document.getElementById('dashboard');
        
        // --- CHART & DATA VARIABLES ---
        let financialChart, cptChart, monthlyTrendChart;
        let allVisitsData = [];
        let dataWorker;

        // --- WEB WORKER SCRIPT ---
        const workerScript = `
            self.importScripts('https://cdn.jsdelivr.net/npm/xlsx/dist/xlsx.full.min.js');

            function parseTxtReport(text) {
                const lines = text.split('\\n');
                const patients = [];
                let currentPatient = null;
                
                const patientRegex = /^Patient:\\s+(.*?)\\s+Patient ID:\\s+(\\S+)/;
                const insuranceRegex = /^Insurance:\\s+(.*?)(?:\\s+Provider:|$)/;
                const officeRegex = /Office:\\s+(.*)/;
                const serviceRegex = /^(\\s*\\d{1,2}\\/\\d{1,2}\\/\\d{4})\\s+(\\S+)\\s+(\\S+)\\s+.*?\\s+(\\(?\\$[\\d,.]+\\)?)\\s+(\\(?\\$[\\d,.]+\\)?)\\s+(\\(?\\$[\\d,.]+\\)?)\\s+(\\(?\\$[\\d,.]+\\)?)\\s+(\\(?\\$[\\d,.]+\\)?)\\s*$/;
                
                const parseCurrency = (str) => {
                    if (!str) return 0;
                    const value = parseFloat(str.replace(/[\\$,()]/g, ''));
                    return str.includes('(') ? -value : value;
                };

                for (const line of lines) {
                    const patientMatch = line.match(patientRegex);
                    const insuranceMatch = line.match(insuranceRegex);
                    const officeMatch = line.match(officeRegex);
                    const serviceMatch = line.match(serviceRegex);

                    if (patientMatch) {
                        if (currentPatient) patients.push(currentPatient);
                        currentPatient = {
                            patientName: patientMatch[1].trim(),
                            patientId: patientMatch[2].trim(),
                            insurance: 'N/A',
                            office: 'N/A',
                            visits: []
                        };
                    }
                    
                    if (currentPatient) {
                        if (insuranceMatch) currentPatient.insurance = insuranceMatch[1].trim();
                        if (officeMatch) currentPatient.office = officeMatch[1].trim();
                        if (serviceMatch) {
                            currentPatient.visits.push({
                                dateOfService: serviceMatch[1].trim(), pos: serviceMatch[2].trim(), cpt: serviceMatch[3].trim(),
                                charges: parseCurrency(serviceMatch[4]), insurancePayment: parseCurrency(serviceMatch[5]),
                                patientPayment: parseCurrency(serviceMatch[6]), adjustment: parseCurrency(serviceMatch[7]),
                                balance: parseCurrency(serviceMatch[8])
                            });
                        }
                    }
                }
                if (currentPatient) patients.push(currentPatient);
                return patients;
            }

            self.onmessage = function(e) {
                try {
                    const { fileType, fileData } = e.data;
                    let parsedData;
                    if (fileType === 'txt') {
                        parsedData = parseTxtReport(fileData);
                    } else {
                        // For Excel, we'll just read it and pass the text to the txt parser
                        // This simplifies logic and handles unstructured data pasted into excel.
                        const workbook = self.XLSX.read(fileData, { type: 'array' });
                        const sheetName = workbook.SheetNames[0];
                        const worksheet = workbook.Sheets[sheetName];
                        const text = self.XLSX.utils.sheet_to_csv(worksheet, { header: 1, FS: "\\t" }).replace(/,/g, ' ');
                        parsedData = parseTxtReport(text);
                    }
                    self.postMessage({ success: true, data: parsedData });
                } catch (error) {
                    self.postMessage({ success: false, error: error.message });
                }
            };
        `;
        const blob = new Blob([workerScript], { type: 'application/javascript' });
        const workerUrl = URL.createObjectURL(blob);

        // --- FILE INPUT HANDLER ---
        fileInput.addEventListener('change', (event) => {
            const file = event.target.files[0];
            if (!file) return;

            fileNameDisplay.textContent = `File: ${file.name}`;
            loadingText.textContent = 'Processing...';
            loadingSpinner.classList.remove('hidden');
            dashboard.classList.add('hidden');
            
            if (dataWorker) dataWorker.terminate();
            dataWorker = new Worker(workerUrl);

            dataWorker.onmessage = (e) => {
                loadingSpinner.classList.add('hidden');
                if (e.data.success) {
                    const data = e.data.data;
                    if (data.length === 0) {
                        alert("No patient data could be parsed. Please check the file format.");
                        return;
                    }
                    allVisitsData = data.flatMap(p => p.visits.map(v => ({ 
                        ...v, 
                        patientName: p.patientName, 
                        patientId: p.patientId,
                        office: p.office,
                        payer: p.insurance 
                    })));
                    displayAnalytics(data, allVisitsData);
                    dashboard.classList.remove('hidden');
                } else {
                    console.error("Error from worker:", e.data.error);
                    alert("Could not process the file. Please ensure it's in the correct format.");
                }
                dataWorker.terminate(); 
            };

            dataWorker.onerror = (e) => {
                console.error('Worker error:', e);
                alert('An unexpected error occurred during file processing.');
                loadingSpinner.classList.add('hidden');
                dataWorker.terminate();
            };

            const reader = new FileReader();
            reader.onload = (e) => {
                loadingText.textContent = 'Parsing file, this may take a moment...';
                if (file.name.endsWith('.txt')) {
                    dataWorker.postMessage({ fileType: 'txt', fileData: e.target.result });
                } else {
                    dataWorker.postMessage({ fileType: 'excel', fileData: e.target.result }, [e.target.result]);
                }
            };

            if (file.name.endsWith('.txt')) {
                reader.readAsText(file);
            } else {
                reader.readAsArrayBuffer(file);
            }
        });

        // --- ANALYTICS & DISPLAY ---
        function displayAnalytics(patientData, visitData) {
            const totals = visitData.reduce((acc, visit) => {
                acc.charges += visit.charges || 0;
                acc.payments += (visit.insurancePayment || 0) + (visit.patientPayment || 0);
                acc.adjustments += visit.adjustment || 0;
                acc.balance += visit.balance || 0;
                return acc;
            }, { charges: 0, payments: 0, adjustments: 0, balance: 0 });

            document.getElementById('totalPatients').textContent = patientData.length;
            document.getElementById('totalVisits').textContent = visitData.length;
            document.getElementById('totalCharges').textContent = totals.charges.toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            document.getElementById('totalPayments').textContent = Math.abs(totals.payments).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            document.getElementById('totalAdjustments').textContent = Math.abs(totals.adjustments).toLocaleString('en-US', { style: 'currency', currency: 'USD' });
            document.getElementById('totalBalance').textContent = totals.balance.toLocaleString('en-US', { style: 'currency', currency: 'USD' });

            createOrUpdateCharts(totals, visitData);
            renderDataTable(visitData);
            renderCptAnalysisTable(visitData);
            renderPayerPaymentTable(visitData);
        }

        function createOrUpdateCharts(totals, visitData) {
            const financialCtx = document.getElementById('financialChart').getContext('2d');
            if (financialChart) financialChart.destroy();
            financialChart = new Chart(financialCtx, {
                type: 'bar', data: { labels: ['Total Charges', 'Total Payments', 'Total Adjustments', 'Balance'], datasets: [{ label: 'Amount (USD)', data: [totals.charges, Math.abs(totals.payments), Math.abs(totals.adjustments), totals.balance], backgroundColor: ['#3b82f6', '#16a34a', '#f59e0b', '#ef4444'], borderRadius: 4 }] },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
            });

            const cptData = visitData.reduce((acc, visit) => { acc[visit.cpt] = (acc[visit.cpt] || 0) + visit.charges; return acc; }, {});
            const sortedCpt = Object.entries(cptData).sort((a, b) => b[1] - a[1]).slice(0, 5);
            const cptCtx = document.getElementById('cptChart').getContext('2d');
            if(cptChart) cptChart.destroy();
            cptChart = new Chart(cptCtx, {
                type: 'doughnut', data: { labels: sortedCpt.map(c => c[0]), datasets: [{ label: 'Charges by CPT', data: sortedCpt.map(c => c[1]), backgroundColor: ['#3b82f6', '#16a34a', '#ef4444', '#f59e0b', '#6366f1'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });

            const monthlyData = visitData.reduce((acc, visit) => {
                try {
                    const dateParts = visit.dateOfService.split('/');
                    if (dateParts.length !== 3) return acc;
                    const date = new Date(dateParts[2], dateParts[0] - 1, dateParts[1]);
                    if (isNaN(date.getTime())) return acc;
                    const month = date.toLocaleString('default', { month: 'short', year: '2-digit' });
                    if (!acc[month]) { acc[month] = { charges: 0, payments: 0, dateObj: date }; }
                    acc[month].charges += visit.charges || 0;
                    acc[month].payments += Math.abs((visit.insurancePayment || 0) + (visit.patientPayment || 0));
                    return acc;
                } catch (e) { return acc; }
            }, {});
            const sortedMonths = Object.values(monthlyData).sort((a,b) => a.dateObj - b.dateObj);
            const monthlyCtx = document.getElementById('monthlyTrendChart').getContext('2d');
            if(monthlyTrendChart) monthlyTrendChart.destroy();
            monthlyTrendChart = new Chart(monthlyCtx, {
                type: 'line', data: { labels: sortedMonths.map(m => m.dateObj.toLocaleString('default', { month: 'short', year: '2-digit' })), datasets: [ { label: 'Charges', data: sortedMonths.map(m => m.charges), borderColor: '#3b82f6', backgroundColor: '#3b82f620', fill: true, tension: 0.3 }, { label: 'Payments', data: sortedMonths.map(m => m.payments), borderColor: '#16a34a', backgroundColor: '#16a34a20', fill: true, tension: 0.3 } ] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }
        
        function renderDataTable(data) {
            const tableBody = document.getElementById('dataTable');
            const rows = data.map(visit => {
                const totalPayment = (visit.insurancePayment || 0) + (visit.patientPayment || 0);
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${visit.patientName}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${visit.office}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${visit.payer}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${visit.dateOfService}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${visit.cpt}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${(visit.charges || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 text-right">${Math.abs(totalPayment).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-semibold text-red-600 text-right">${(visit.balance || 0).toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = rows || '<tr><td colspan="8" class="text-center py-4">No data available.</td></tr>';
        }

        function renderCptAnalysisTable(visitData) {
            const targetOffice = "Sun Health Care Surgery Group Inc";
            const targetPrefixes = ['L', 'Q', 'A'];
            const analysisData = visitData
                .filter(v => v.office && v.office.includes(targetOffice) && v.cpt && targetPrefixes.some(p => v.cpt.startsWith(p)))
                .reduce((acc, visit) => {
                    if (!acc[visit.cpt]) {
                        acc[visit.cpt] = { billed: 0, paid: 0, totalPayment: 0 };
                    }
                    const payment = Math.abs((visit.insurancePayment || 0) + (visit.patientPayment || 0));
                    acc[visit.cpt].billed += 1;
                    if (payment > 0) {
                        acc[visit.cpt].paid += 1;
                        acc[visit.cpt].totalPayment += payment;
                    }
                    return acc;
                }, {});

            const tableBody = document.getElementById('cptAnalysisTable');
            const rows = Object.entries(analysisData).map(([cpt, data]) => {
                const avgPay = data.paid > 0 ? (data.totalPayment / data.paid) : 0;
                return `
                    <tr>
                        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${cpt}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${data.billed}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${data.paid}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 text-right">${data.totalPayment.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                        <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 font-semibold text-right">${avgPay.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                    </tr>
                `;
            }).join('');
            tableBody.innerHTML = rows || `<tr><td colspan="5" class="text-center py-4">No matching CPT data found for ${targetOffice}.</td></tr>`;
        }

        function renderPayerPaymentTable(visitData) {
            const paymentData = visitData.reduce((acc, visit) => {
                const totalPayment = Math.abs((visit.insurancePayment || 0) + (visit.patientPayment || 0));
                if (totalPayment > 0 && visit.cpt && visit.payer) {
                    const key = `${visit.cpt}|${visit.payer}|${totalPayment.toFixed(2)}`;
                    if (!acc[key]) {
                        acc[key] = { cpt: visit.cpt, payer: visit.payer, amount: totalPayment, count: 0 };
                    }
                    acc[key].count += 1;
                }
                return acc;
            }, {});
            
            const tableBody = document.getElementById('payerPaymentTable');
            const rows = Object.values(paymentData).sort((a,b) => a.cpt.localeCompare(b.cpt) || a.payer.localeCompare(b.payer) || b.amount - a.amount).map(data => `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">${data.cpt}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">${data.payer}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-green-600 text-right">${data.amount.toLocaleString('en-US', { style: 'currency', currency: 'USD' })}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 text-right">${data.count}</td>
                </tr>
            `).join('');
            tableBody.innerHTML = rows || '<tr><td colspan="4" class="text-center py-4">No payment data available.</td></tr>';
        }

        // --- EXPORT & SEARCH ---
        function exportToCsv(data) {
            const headers = ['PatientName', 'PatientID', 'Office', 'Payer', 'DateOfService', 'POS', 'CPT', 'Charges', 'InsurancePayment', 'PatientPayment', 'Adjustment', 'Balance'];
            const csvRows = [headers.join(',')];
            for (const row of data) {
                const values = [
                    `"${(row.patientName || '').replace(/"/g, '""')}"`,
                    row.patientId,
                    `"${(row.office || '').replace(/"/g, '""')}"`,
                    `"${(row.payer || '').replace(/"/g, '""')}"`,
                    row.dateOfService,
                    row.pos,
                    row.cpt,
                    row.charges || 0,
                    row.insurancePayment || 0,
                    row.patientPayment || 0,
                    row.adjustment || 0,
                    row.balance || 0
                ];
                csvRows.push(values.join(','));
            }
            const csvString = csvRows.join('\n');
            const blob = new Blob([csvString], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.setAttribute('hidden', '');
            a.setAttribute('href', url);
            a.setAttribute('download', 'analytics_export.csv');
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        }
        
        document.getElementById('exportCsv').addEventListener('click', () => {
            if (allVisitsData.length > 0) {
                exportToCsv(allVisitsData);
            } else {
                alert("No data available to export.");
            }
        });

        document.getElementById('searchInput').addEventListener('keyup', (e) => {
            const searchTerm = e.target.value.toLowerCase();
            const filteredData = allVisitsData.filter(visit => 
                (visit.patientName || '').toLowerCase().includes(searchTerm) ||
                (visit.office || '').toLowerCase().includes(searchTerm) ||
                (visit.payer || '').toLowerCase().includes(searchTerm) ||
                String(visit.patientId || '').toLowerCase().includes(searchTerm) ||
                String(visit.dateOfService || '').toLowerCase().includes(searchTerm) ||
                String(visit.cpt || '').toLowerCase().includes(searchTerm)
            );
            renderDataTable(filteredData);
        });

    </script>
</body>
</html>

